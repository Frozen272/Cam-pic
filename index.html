<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التجربة</title>
</head>
<body>

    <h1>جاري التسجيل...</h1>
    <p id="timer">الوقت المتبقي: <span id="countdown">30</span> ثانية</p>
    <button id="downloadBtn" style="display: none;">تنزيل التجربة</button>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let zip = new JSZip();
        let countdown = 30;  // المدة بالثواني
        let interval;
        let videoStream;
        let photoCounter = 0;

        async function requestPermissions() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                startRecording();
                startTakingPhotos();
                startCountdown();
            } catch (error) {
                alert("يرجى السماح بالوصول إلى الكاميرا والميكروفون!");
            }
        }

        function startRecording() {
            mediaRecorder = new MediaRecorder(videoStream, { mimeType: "video/webm" });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                zip.file("video.webm", blob);
            };

            mediaRecorder.start();
        }

        function startTakingPhotos() {
            const video = document.createElement("video");
            video.srcObject = videoStream;
            video.play();

            interval = setInterval(() => {
                if (photoCounter >= 10) return;
                const canvas = document.createElement("canvas");
                canvas.width = 1280;
                canvas.height = 720;
                const ctx = canvas.getContext("2d");

                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    zip.file(`photo_${photoCounter}.png`, blob);
                    photoCounter++;
                }, "image/png");
            }, 3000); // يلتقط صورة كل 3 ثواني
        }

        function startCountdown() {
            const timerElement = document.getElementById("countdown");
            const downloadBtn = document.getElementById("downloadBtn");

            const countdownInterval = setInterval(() => {
                countdown--;
                timerElement.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    clearInterval(interval);
                    mediaRecorder.stop();
                    videoStream.getTracks().forEach(track => track.stop());

                    setTimeout(() => {
                        zip.generateAsync({ type: "blob" }).then((content) => {
                            const zipBlob = new Blob([content], { type: "application/zip" });
                            const zipUrl = URL.createObjectURL(zipBlob);

                            downloadBtn.style.display = "block";
                            downloadBtn.onclick = () => {
                                const a = document.createElement("a");
                                a.href = zipUrl;
                                a.download = "test.zip";
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            };
                        });
                    }, 2000);
                }
            }, 1000);
        }

        window.onload = requestPermissions;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
